name: JWT μλ™μƒμ„± λ° μ΄λ©”μΌ λ°μ†΅

on:
  schedule:
    - cron: '50 5 * * *'  # JST 14:50 (UTC 5:50)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APPLICATION_ID: ${{ secrets.APPLICATION_ID }}
      PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

    steps:
      - name: μ½”λ“ λ‹¤μ΄λ΅λ“
        uses: actions/checkout@v3

      - name: Node.js μ„¤μΉ
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ν¨ν‚¤μ§€ μ„¤μΉ
        run: npm install

      - name: JWT μƒμ„± λ° μ €μ¥
        run: node index.js

      - name: ν„μ¬ μ‹κ°„ μ¶λ ¥
        run: |
          echo "π•’ ν„μ¬ μ‹κ°„ (UTC):"
          date -u
          echo "π•’ ν„μ¬ μ‹κ°„ (JST):"
          TZ=Asia/Tokyo date

      - name: μ΄λ©”μΌ μ „μ†΅μ„ μ„ν• Python μ„¤μΉ
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install yagmail

      - name: JWT μ΄λ©”μΌ μ „μ†΅
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
        run: |
          echo "π“¤ μ΄λ©”μΌ μ „μ†΅ μ‹μ‘..."
          python3 <<EOF
import yagmail
yag = yagmail.SMTP(user="${carbon7727@gmail.com}", password="${jmswΒ kdaaΒ lyzvΒ svea}")
yag.send(to="${carbon7727@gmail.com}", subject="π” μƒ JWT ν† ν°", contents="μ²¨λ¶€λ jwt.txt νμΌμ„ ν™•μΈν•μ„Έμ”.", attachments="jwt.txt")
print("β… μ΄λ©”μΌ μ „μ†΅ μ™„λ£")
EOF
