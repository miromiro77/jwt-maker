name: JWT ìë™ìƒì„± ë° ì´ë©”ì¼ ë°œì†¡

on:
  schedule:
    - cron: '0 20 * * *'  # ë§¤ì¼ UTC 20ì‹œ (JST/KST 05ì‹œ)
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APPLICATION_ID: ${{ secrets.APPLICATION_ID }}
      PRIVATE_KEY:     ${{ secrets.PRIVATE_KEY }}
      SERVICE_ACCOUNT_JSON: ${{ secrets.SERVICE_ACCOUNT_JSON }}   # NEW
      SPREADSHEET_ID:       ${{ secrets.SPREADSHEET_ID }}         # NEW

    steps:
      - name: ì½”ë“œ ë‹¤ìš´ë¡œë“œ
        uses: actions/checkout@v4     # v3 -> v4 (ê¶Œì¥)

      - name: Node.js ì„¤ì¹˜
        uses: actions/setup-node@v4   # v3 -> v4 (ê¶Œì¥)
        with:
          node-version: '20'          # 18ë„ OK, 20 ê¶Œì¥
          cache: 'npm'

      - name: íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: npm install

      - name: í˜„ì¬ ì‹œê°„ ì¶œë ¥
        run: |
          echo "ğŸ•’ í˜„ì¬ ì‹œê°„ (UTC):"; date -u
          echo "ğŸ•’ í˜„ì¬ ì‹œê°„ (JST):"; TZ=Asia/Tokyo date

      - name: JWT ìƒì„± & ì‹œíŠ¸ ê¸°ë¡
        run: node index.js             # index.jsê°€ B2ì— ê¸°ë¡

      # ===== ì•„ë˜ëŠ” ê¸°ì¡´ ì´ë©”ì¼ ë°œì†¡ ìœ ì§€ =====
      - name: ì´ë©”ì¼ ì „ì†¡ì„ ìœ„í•œ Python ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install yagmail

      - name: JWT ì´ë©”ì¼ ì „ì†¡
        env:
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          MAIL_TO:       ${{ secrets.MAIL_TO }}
        run: |
          echo "ğŸ“¤ ì´ë©”ì¼ ì „ì†¡ ì‹œì‘..."
          python3 .github/scripts/send_jwt_email.py
